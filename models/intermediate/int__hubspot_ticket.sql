WITH ticket_base AS (
  SELECT 
    -- Basic identifiers
    ticket_id,
    hubspot_object_id,
    ticket_number,
    
    -- Question 1: Generated by Coral Care vs. inbound
    last_email_type,
    is_outbound_ticket,
    object_source,
    object_source_label,
    
    -- Question 2: Urgency  
    ticket_priority,
    
    -- Question 4: Subject Line
    subject_line,
    email_subject,
    
    -- Question 6 & 8: Time to first response
    first_response_sla_status,
    time_to_first_response_hours,
    first_response_sla_timestamp,
    time_to_first_agent_reply,
    first_agent_reply_date,
    
    -- Question 7: Coral Care member who took care of ticket
    owner_id,
    team_id,
    assigned_team_ids,
    owner_assigned_date,
    
    -- Question 9: Time to ticket close
    time_to_close,
    time_to_close_hours,
    close_sla_timestamp,
    closed_date,
    last_closed_date,
    
    -- Question 10: SLA status
    first_response_sla,
    close_sla_status,
    next_response_sla_status,
    sla_rule_config_id,
    sla_schedule_id,
    
    -- Question 11: Support vs. Provider Pipeline
    pipeline,
    pipeline_stage,
    
    -- Additional useful fields
    ticket_category,
    in_helpdesk,
    visible_in_help_desk,
    num_conversations,
    num_companies,
    primary_company_id,
    primary_company_name,
    
    -- Timestamps
    created_date,
    last_modified_date,
    last_activity_date,
    last_contacted_date,
    
    -- Content and notes
    ticket_content,
    num_notes,
    num_times_contacted,
    
    -- Assignment and routing
    assignment_method,
    created_by,
    
    -- Email tracking
    last_email_date,
    last_email_id,
    sales_email_last_replied,
    
    -- Fivetran metadata
    fivetran_synced,
    is_deleted
    
  FROM {{ ref('stg__hubspot__ticket') }}
),

ticket_with_contact AS (
  SELECT 
    t.*,
    tc.contact_id,
    CASE 
      WHEN p.coral_provider_id IS NOT NULL THEN p.coral_provider_id
      ELSE NULL
    END as coral_provider_id,
    CASE 
      WHEN p.coral_provider_id IS NULL AND pa.coral_parent_id IS NOT NULL THEN pa.coral_parent_id
      ELSE NULL
    END as coral_parent_id,
    -- Add contact count per ticket
    COUNT(tc.contact_id) OVER (PARTITION BY t.ticket_id) AS num_contacts_on_ticket
  FROM ticket_base t
  LEFT JOIN {{ ref('stg__hubspot__ticket_contact') }} tc 
    ON t.ticket_id = tc.ticket_id
  LEFT JOIN {{ref('int__provider')}} p 
    ON tc.contact_id = p.hubspot_provider_id
  LEFT JOIN {{ref('int__parent')}} pa 
    ON tc.contact_id = pa.hubspot_parent_id 
),

final AS (
  SELECT 
    *,
    
    -- Derived fields for analysis
    CASE 
      WHEN last_email_type = 'AUTOMATED_EMAIL' THEN 'Coral Care Generated'
      WHEN last_email_type IN ('REGULAR_EMAIL', 'REPLY') THEN 'Inbound'
      WHEN is_outbound_ticket = TRUE THEN 'Coral Care Generated'
      ELSE 'Unknown'
    END AS ticket_origin_type,
    
    CASE 
      WHEN ticket_priority = 'HIGH' THEN 'High'
      WHEN ticket_priority = 'MEDIUM' THEN 'Medium' 
      WHEN ticket_priority = 'LOW' THEN 'Low'
      ELSE 'Not Set'
    END AS priority_clean,
    
    CASE 
      WHEN pipeline ILIKE '%support%' THEN 'Support'
      WHEN pipeline ILIKE '%provider%' THEN 'Provider'
      ELSE 'Other'
    END AS pipeline_type,
    
    -- Time calculations (convert milliseconds to hours if needed)
    CASE 
      WHEN time_to_first_response_hours IS NOT NULL 
      THEN time_to_first_response_hours / 60.0 -- Convert minutes to hours
      WHEN time_to_first_agent_reply IS NOT NULL 
      THEN time_to_first_agent_reply / (1000 * 60 * 60.0) -- Convert ms to hours
      ELSE NULL
    END AS first_response_time_hours,
    
    CASE 
      WHEN time_to_close_hours IS NOT NULL 
      THEN time_to_close_hours / 60.0 -- Convert minutes to hours  
      WHEN time_to_close IS NOT NULL 
      THEN time_to_close / (1000 * 60 * 60.0) -- Convert ms to hours
      ELSE NULL
    END AS time_to_close_hours_calc,
    
    -- Ticket status
    CASE 
      WHEN closed_date IS NOT NULL THEN 'Closed'
      ELSE 'Open'
    END AS ticket_status

  FROM ticket_with_contact
)

SELECT * FROM final